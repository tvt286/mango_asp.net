@using Mango.Common
@using Mango.Client.Common
@using Mango.Services
@using Mango.Security
@using Mango.Data.Enums
@using Mango.Web

@model Mango.Data.StoreOrder

@{
    ViewBag.Title = "Create Order Import";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-xs-12">
        <div class="page-title-box">
            <h4 class="page-title">Create Order Import</h4>
            <ol class="breadcrumb p-0 m-0">
                <li>
                    <a href="@Url.Action("Index","Home")">Mango</a>
                </li>
                <li>
                    <a href="@Url.Action("Index")">Create Order Import</a>
                </li>
                <li class="active">
                    <strong>Create</strong>
                </li>
            </ol>

            <div class="clearfix"></div>
            <a style="margin-right:10px" onclick="$('#btCreate').click()" class="btn btn-primary waves-effect waves-light m-t-sm">Save</a>
            @Html.ActionLink("Cancel", "Index", null, new { @class = "btn btn-default waves-effect m-t-sm" })
        </div>
    </div>
</div>
<!-- end row -->
@using (Ajax.BeginForm("CreateStoreOrderImport", "StoreOrder", null, new AjaxCommonOption(), new { role = "form", id = "CreateForm" }))
{
    @Html.HiddenFor(x => x.Id)
    @Html.HiddenFor(x => x.StoreImExTypeCode)
    <div class="row">
        <div class="col-sm-12">
            <div class="card-box animated fadeInRight">

                <div class="row">

                    <div class="form-horizontal">
                        <div class="form-group">
                            @if (Model.Id != 0)
                            {
                                <label class="control-label col-md-2">Phiếu nhập<span style="color: Red">(*)</span></label>
                                <div class="col-md-4">
                                    @Html.TextBoxFor(x => x.Code, null, new { @class = "form-control", disabled = "disabled", placeholder = "Mã tự động" })
                                    @*@Html.ValidationMessageFor(model => model.Code, "", new { @class = "text-danger" })*@
                                </div>
                            }

                            <label class="control-label col-md-2">Ngày nhập<span style="color: Red">(*)</span></label>
                            <div class="col-md-4">
                                <div class="input-group date">
                                    @Html.TextBoxFor(x => x.TimeImport, new { @class = "form-control", data_val = "true", data_val_required = "Thông tin bắt buộc" })
                                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                </div>
                                @Html.ValidationMessageFor(model => model.TimeImport, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-2">Người nhập<span style="color: Red">(*)</span></label>
                            <div class="col-md-4">
                                @Html.DropDownListFor(x => x.UserImportId, null, "-- Người nhập --", new { @class = "form-control", data_val = "true", data_val_required = "Thông tin bắt buộc" })
                                @Html.ValidationMessageFor(x => x.UserImportId, "", new { @class = "text-danger" })
                            </div>
                            <label class="control-label col-md-2">Kho nhập<span style="color: Red">(*)</span></label>
                            <div class="col-md-4">
                                @Html.DropDownListFor(x => x.RefStoreId, null, "-- Kho nhập --", new { @class = "form-control", data_val = "true", data_val_required = "Thông tin bắt buộc" })
                                @Html.ValidationMessageFor(x => x.RefStoreId, "", new { @class = "text-danger" })
                            </div>
                        </div>


                        <div class="form-group">
                            <label class="control-label col-md-2">Ghi chú</label>
                            <div class="col-md-4">
                                @Html.TextAreaFor(x => x.Note, new { @class = "form-control", @placeholder = "Ghi chú" })
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="card-box table-responsive">
                @if (Model.Id == 0)
                {
                    <div style="margin-bottom:10px">
                        <button class="btn btn-primary" type="button" id="btAdd">
                            <i class="fa fa-plus"></i>
                            <span class="bold">Add product</span>
                        </button>
                        <br style="clear: both" />
                    </div>
                }
                <div>
                    <table id="tableImportDetail" class="table table-striped table-colored table-info table-hover">
                        <tr>
                            <th>
                                Image
                            </th>

                            <th>
                                Product
                            </th>
                           
                            <th>
                                Category
                            </th>

                            <th style="width: 70px">
                                Quantity Import
                            </th>

                            <th>
                                Price
                            </th>

                            @if (Model.Id == 0)
                            {
                                <th></th>
                            }

                        </tr>
                        @if (Model.Id != 0)
                        {
                            foreach (var item in Model.StoreOrderImportDetails)
                            {
                                <tr>
                                    <td>
                                        <img class="imageProduct" style="width: 50px;" src="@Url.ImageProduct(item.Product)" />
                                    </td>

                                    <td>
                                        @item.Product.Name
                                    </td>
                                    <td class="category">
                                        @item.Product.Category.Name
                                    </td>
                                   

                                    <td>
                                        @item.Quantity.ToString("0.##")
                                    </td>

                                    <td>
                                        @item.MainSupplierPrice.MoneyToStringVN()
                                    </td>


                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td>
                                    @Html.DropDownList("productId", (List<SelectListItem>)ViewBag.ProductSelect, "-- Product --", new { @class = "form-control", onchange = "ChangeProduct(this)", style = "width:120px" })
                                </td>
                                <td>
                                    <img class="imageProduct" style="display: none; width: 50px;" />
                                </td>

                                <td class="category"></td>
                              
                                <td style="text-align:center">
                                    <input type="text" class="form-control autoNumeric" placeholder="Quantity" name="quantityRequestImport" onblur="CalculateExchange(this)" style="width: 70px" />
                                </td>
                                <td style="text-align:center">
                                    <input type="text" placeholder="Price" class="form-control autoNumeric" name="mainSupplierPrice"  />
                                </td>

                                <td >
                                    <a href="javascript:void(0)" onclick="RemoveProduct(this)">
                                        <i class="fa fa-times" style="color: red"></i>
                                    </a>
                                </td>
                            </tr>
                        }

                    </table>

                </div>


                @if (Model.Id == 0)
                {
                    <input class="btn btn-primary m-t-sm" type="submit" id="btUpdate" value="Save" />
                }
                @Html.ActionLink("Cancel", "StoreOrderImport", null, htmlAttributes: new { @class = "btn btn-default m-t-sm", role = "button" })
            </div>
        </div>

    </div>
}

@section Styles {
    <link href="~/Content/Admin/chosen.css" rel="stylesheet" />

    <style>
        .input-validation-error {
            border: 1px solid red;
        }
    </style>
}

@section scripts
{
    <script src="~/Scripts/Admin/chosen.jquery.js"></script>
    @if (Model.Id != 0)
    {
        <script type="text/javascript">
            $(function () {
                $("input").attr("disabled", "disabled");
                $("select").attr("disabled", "disabled");
                //$("textarea").attr("disabled", "disabled");
                $("body").addClass("mini-navbar");
            })
        </script>
    }
    else
    {
        <script type="text/javascript">
            function InitFormImportDetail() {
                $('#CreateForm .input-group.date').datetimepicker({
                    locale: 'vi',
                    format: 'DD/MM/YYYY',
                    extraFormats: ["MM/YYYY"],
                    defaultDate: null
                });


                $("input[name=quantityRequestImport]:last, " +
                        "input[name=amountDateAlert]:last, " +
                        "input[name=mainSupplierPrice]:last")
                    .autoNumeric('init', { aPad: false, aSep: '.', aDec: ',', vMin: 0.00, vMax: 99999999999999999.00 });

            }

            function CalculateExchange(element) {
                var exchange = $(element).closest("tr").find("select[name=unitDetailId]").find(":selected").attr("exchange");
                var quantity = $(element).closest("tr").find("input[name=quantityRequestImport]").autoNumeric('get');
                if (exchange == "0" || quantity == "" || quantity == "0") {
                    $(element).closest("tr").find(".exchange").html("0");
                } else {
                    var number = parseInt(exchange) * parseInt(quantity);
                    $(element).closest("tr").find(".exchange").html(number);

                }
            }

            function ChangeProduct(element) {
                OnBeginAjax();
                var id = $(element).val();
                var unitDetailSelect = $(element).closest("tr").find("select[name=unitDetailId]");
                $(unitDetailSelect).find("option[value\!='']").remove();
                $(unitDetailSelect).val("");
                $.post('@Url.Action("GetInfoProduct","Product")',
                    {
                        id: id
                    },
                    function (data) {
                        //$(element).closest("tr").find(".supplierPrice").html(data.SupplierPrice);
                        //$(element).closest("tr").find(".sellingPrice").html(data.SellingPrice);

                        $(element).closest("tr").find("input[name=mainSupplierPrice]").val(data.SupplierPrice.replace(".", ""));
                        if (data.Image != "") {
                            $(element).closest("tr").find(".imageProduct").attr("src", data.Image).show();
                        } else {
                            $(element).closest("tr").find(".imageProduct").hide();
                        }
                        $(element).closest("tr").find(".category").html(data.CategoryName);
                        //for (var i = 0; i < data.UnitDetailList.length; i++) {
                        //    var item = data.UnitDetailList[i];
                        //    $(unitDetailSelect).append($('<option></option>').val(item.Id).html(item.Name).attr("exchange", item.UnitExchange));
                        //}

                        OnCompleteAjax();
                    });
            }

            function RemoveProduct(element) {
                if (confirm("Xác nhận xóa!")) {
                    $(element).closest("tr").remove();
                }
            }

            function validateFields() {
                var submit = true;
                $.each($("#CreateForm select[name='productId'], #CreateForm select[name='unitDetailId'], #CreateForm input[name='packages'], #CreateForm input[name='expireDate'], #CreateForm input[name='amountDateAlert'], #CreateForm input[name='quantityRequestImport'], #CreateForm input[name='mainSupplierPrice']"), function (i, element) {
                    if ($(element).val() == "") {
                        submit = false;
                        $(element).addClass("input-validation-error");
                    } else {
                        $(element).removeClass("input-validation-error");
                    }
                });
                return submit;
            }

            $(function () {
                $("body").addClass("mini-navbar");

                var cloned = $("#tableImportDetail tr:last")[0].outerHTML;
              
                $("body").addClass("mini-navbar");
                $("input[name=mainSupplierPrice], input[name=quantityRequestImport]")
                    .autoNumeric('init', { aPad: false, aSep: '.', aDec: ',', vMin: 0.00, vMax: 99999999999999999.00 });

                $("#btAdd").click(function () {
                    $("#tableImportDetail").append(cloned);
                    $.removeData($('#CreateForm').get(0), 'validator');
                    jQuery.validator.unobtrusive.parse('#CreateForm');
                    InitFormImportDetail();
                });

                $("#CreateForm")
                    .submit(function () {
                        if (validateFields() == false) {
                            return false;
                        }

                        $('.autoNumeric').each(function (i) {
                            var self = $(this);
                            try {
                                var v = self.autoNumeric('get');
                                //self.autoNumeric('destroy');
                                self.val(v);
                            } catch (err) {
                                self.val(0);
                            }
                        });
                    });
            });


        </script>
    }

}
